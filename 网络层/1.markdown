## 网络层基本概念

网络层的主要任务是实现网络互联，进而实现数据包在各网络之间的运输。因特网使用TCP/IP协议栈，其网络层使用**网际协议IP**，是整个协议栈的核心协议，所以TCP/IP协议栈中网络层又叫**网际层**

**网络层要解决三个问题：**

1. **提供怎样的服务？可靠传输服务，还是不可靠传输**

在数据传输中可能出现的问题：

- 乱码
- 路由器繁忙，丢弃数据
- 乱序

如果网络层有解决措施，就是可靠传输服务

2. **寻址问题**

网络编号+路由器接口号

3. **路由选择问题**

路由表：目的网络+下一个路由器

## ABC分类编址

![image.png](../assets/ip.png)

一个字节由8位比特组成，每一位可以是0或1。在二进制系统中，一个字节的最大值和最小值如下：

- **最大值**：当所有位都是1时，一个字节的数值达到最大。二进制表示为 `11111111`，这等于十进制的**255**
- **最小值**：当所有位都是0时，一个字节的数值达到最小。二进制表示为 `00000000`，这等于十进制的**0**

**A类网络**：

- 网络地址占用1字节，主机地址占用3字节。
- 网络地址的最高位必须是“0”，地址范围从1.0.0.0到126.255.255.255（因为127.0.0.1是保留的本地回环地址）
- 每个A类网络可以有 \(2^{24}\) - 2 个主机地址（网络地址全0和广播地址全1）
- 所以，A类网络的可用主机数为 \(16777214\) 个（\(16777216 - 2\)）

**B类网络**：

- 网络地址占用2字节，主机地址占用2字节。
- 网络地址的最高位必须是“10”，地址范围从128.0.0.0到191.255.0.0（因为128.0.0.0和191.255.255.255是保留的）
- 每个B类网络可以有 \(2^{16}\) - 2 个主机地址
- 所以，B类网络的可用主机数为 \(65534\) 个（\(65536 - 2\)）

**C类网络**：

- 网络地址占用3字节，主机地址占用1字节。
- 网络地址的最高位必须是“110”，地址范围从192.0.0.0到223.255.255.0（因为192.0.0.0和223.255.255.255是保留的）
- 每个C类网络可以有 \(2^{8}\) - 2 个主机地址
- 所以，C类网络的可用主机数为 \(254\) 个（\(256 - 2\)）

**128.0.0.0** 是B类网络的第一个网络地址，它被保留作为网络标识。在每个IP地址类别中，网络地址的全0和全1形式都是有特殊用途的：

- 全0的网络地址（例如，A类的0.0.0.0，B类的128.0.0.0，C类的192.0.0.0）通常被用作“本网络”的默认路由目的地址，或者在某些情况下，作为网络本身的标识
- 全1的网络地址（例如，A类的127.255.255.255，B类的191.255.255.255，C类的223.255.255.255）通常用作广播地址，用于在同一网络内发送消息到所有主机

## 网络地址和广播地址

**网络地址（Network Address）**：

- 网络地址用于标识特定的网络。在每个子网中，网络地址是该子网的第一个地址。
- 它代表了整个网络而不是网络中的任何单个设备。
- 在子网内的所有主机中，网络地址的主机部分（主机号）全部为0。

**广播地址（Broadcast Address）**：

- 广播地址用于在同一网络内发送消息到所有主机。当数据包发送到广播地址时，该网络内的所有设备都会接收到这个数据包。
- 广播地址是子网内最后一个可用的IP地址。
- 在子网内的所有主机中，广播地址的主机部分全部为1

这两个地址在网络配置和管理中非常重要，它们使得网络设备能够执行以下操作：

- 使用网络地址来确定数据包是否应该在本地网络上路由，或者数据包是否应该被发送到其他网络
- 使用广播地址来实现局域网内所有设备的通信，例如在启动时寻找网络上的设备或发送网络通知

![image.png](../assets/ABC.png)

![image.png](../assets/test.png)

### 特殊的IP地址

私有IP地址的范围如下：

* Class A: 10.0.0.0 - 10.255.255.255
* Class B: 172.16.0.0 - 172.31.255.255
* Class C: 192.168.0.0 - 192.168.255.255

在实际的网络通信中，目的IP地址应该是一个有效的、分配给网络设备的地址。这可以是：

1. **公网IP地址**：在全球互联网上唯一，可以用于路由数据包到全世界任何地方
2. **私有IP地址**：在局域网或组织内部使用，不会在互联网上路由

所以0.1.2.3不可以作为目的IP地址

![image.png](../assets/specialIP.png)

## 子网划分

### 子网掩码

子网掩码（Subnet Mask）是一个32位的数字，用于配合IP地址使用，以标识一个IP地址中哪些位表示网络地址，哪些位表示主机地址。子网掩码通过将IP地址的网络部分和主机部分区分开来，使得可以在一个较大的网络中创建多个较小的子网，或者在不同网络之间进行有效的路由

习题：已知某个网络的地址是218.75.230.0，使用子网掩码255.255.255.128对其进行子网划分：

1. C类网络，8位主机号
2. 128是2的7次幂，表示一位主机号被借走用来划分子网，所以子网为2
3. 256/2 - 2 = 126

第一个子网的网络地址是218.75.230.0，这个子网的主机地址范围是从218.75.230.1到218.75.230.126。
第二个子网的网络地址是218.75.230.128，这个子网的主机地址范围是从218.75.230.129到218.75.230.254

习题：已知某个网络的地址是180.80.77.55，使用子网掩码255.255.252.0对其进行子网划分：

1. B类网络，16位主机号
2. 子网掩码252.0 = 11111100.00000000
3. IP地址77.55 = 01001101
4. 子网号01001100 = 76，网络地址为01001100.00000000 广播地址01001111.11111111
5. 所以网络地址为180.80.76.0，广播地址为180.80.79.255

### 无分类编址的IPv4地址

CIDR，在斜线后面写上网络前缀所占的比特数量

`128.14.35.7/20`，网络占20，主机号占12

所以只要知道CIDE地址块中的任何一个地址，就可以知道全部细节

- 地址块的最小地址
- 地址块的最大地址
- 地址块的地址数量
- 地址块中A，B，C类的数量
- 地址掩码

请给出CIDR地址块`128.14.35.7/20`的全部细节?

`128.14.35.7` = 10000000.00001110.0010**0011.00000111**

最小地址：128.14.32.0

最大地址：128.14.47.255

地址掩码：255.255.240.0

### 路由

#### 路由表

路由表是网络设备（如路由器和交换机）用来决定如何将数据包从一个网络转发到另一个网络的表格。路由表包含一系列的路由条目，每个条目通常包含以下信息：

1. **目的网络**：要到达的网络的IP地址或IP地址范围。
2. **子网掩码**：与目的网络地址一起使用，以确定目的网络的范围。
3. **下一跳地址**：数据包应该发送到的下一个路由器的IP地址，以便到达目的网络。
4. **接口**：数据包应该从哪个网络接口发送出去。

路由表可以是静态的或动态的：

- **静态路由表**：由网络管理员手动配置，不随网络变化而自动更新。
- **动态路由表**：由路由器通过路由协议自动学习和更新。

#### 路由聚合

路由聚合，也称为路由汇总或超网（Supernetting），是一种用于减少路由表大小和提高路由效率的技术。在大型网络中，维护一个包含每个单独网络的路由表可能会非常庞大和低效。路由聚合通过将多个小网络合并成一个较大的网络来简化路由表。

路由聚合的步骤通常如下：

1. **确定聚合网络**：选择一个足够大的网络，可以覆盖多个小网络
2. **创建汇总路由**：为聚合网络创建一个路由条目，这个条目包括聚合网络的地址和子网掩码
3. **替换原有路由**：在路由表中，用新的汇总路由替换掉被聚合的多个小网络的路由

目的网络        子网掩码        下一跳地址
192.168.0.0/24    255.255.255.0   RouterX
192.168.1.0/24    255.255.255.0   RouterX
192.168.2.0/24    255.255.255.0   RouterX
192.168.3.0/24    255.255.255.0   RouterX
192.168.4.0/24    255.255.255.0   RouterX

聚合后到路由表只有一个条目：

目的网络        子网掩码        下一跳地址
192.168.0.0/22   255.255.252.0   RouterX


![image.png](../assets/cidr.png)

![image.png](../assets/4.png)

### 定长子网掩码与变长子网掩码

![image.png](../assets/cidr2.png)

![image.png](../assets/vlsm.png)
